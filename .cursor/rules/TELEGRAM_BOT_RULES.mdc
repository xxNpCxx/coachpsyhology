---
alwaysApply: true
---

# ü§ñ –ü—Ä–∞–≤–∏–ª–∞ Cursor AI - Telegram Bot Development

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û
**Telegram –±–æ—Ç—ã - —ç—Ç–æ –ù–ï –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!** –ù–µ –ø—Ä–∏–º–µ–Ω—è–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–µ–±-–ø—Ä–∞–∫—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## ‚úÖ Telegram —Å–∞–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- CSRF –∑–∞—â–∏—Ç—É
- XSS –∑–∞—â–∏—Ç—É
- Rate limiting
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

## üö´ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è Telegram –±–æ—Ç–æ–≤:
- `SESSION_SECRET` - –Ω–µ –Ω—É–∂–µ–Ω
- `JWT —Ç–æ–∫–µ–Ω—ã` - Telegram ID —É–∂–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `CSRF —Ç–æ–∫–µ–Ω—ã` - –Ω–µ—Ç –≤–µ–±-—Ñ–æ—Ä–º
- `–ü–∞—Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π` - Telegram —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- `–í–µ–±-—Å–µ—Å—Å–∏–∏` - Telegram —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—è–º–∏

## üîß –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

### 1. Webhook
```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
await bot.setWebhook(`${process.env.WEBHOOK_URL}/webhook`);

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
bot.setWebhookInfo(); // –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢
```

### 2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
```javascript
// ‚ùå –ù–ï —Å–º–µ—à–∏–≤–∞–π inline –∏ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
// ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
await bot.sendMessage(chatId, '–î–µ–π—Å—Ç–≤–∏—è:', { reply_markup: inlineKeyboard });
await bot.sendMessage(chatId, '–ú–µ–Ω—é:', { reply_markup: replyKeyboard });
```

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const isAdmin = msg.from.id.toString() === process.env.ADMIN_USER_ID;

// –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
await db.query('SELECT * FROM users WHERE telegram_id = $1', [msg.from.id]);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
try {
    await processRequest(msg);
} catch (error) {
    logger.error('–û—à–∏–±–∫–∞:', error);
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
}
```

### 4. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
TELEGRAM_BOT_TOKEN=your_token
ADMIN_USER_ID=your_telegram_id
DATABASE_URL=postgresql://...
WEBHOOK_URL=https://your-domain.com
```

## üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ middleware –∏ FSM

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ1: –ü–æ—Ä—è–¥–æ–∫ middleware –∏–º–µ–µ—Ç —Ä–µ—à–∞—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ—Ä—è–¥–æ–∫ –≤ bot.js:
const bot = new Telegraf(BOT_TOKEN);
const stage = new Scenes.Stage([...scenes]);

// 1. Session middleware –ü–ï–†–í–´–ú
bot.use(session({ defaultSession: () => ({}) }));

// 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –î–û stage.middleware()
bot.use(async (ctx, next) => {
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∏, –ù–û –ù–ï –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥!
  if (ctx.scene && ctx.scene.current) {
    return await next(); // –ü–µ—Ä–µ–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞–º
  }
  // –¢–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞, –ù–ï –∫–æ–º–∞–Ω–¥—ã
  await next();
});

// 3. Stage middleware –¥–ª—è FSM —Å—Ü–µ–Ω
bot.use(stage.middleware());

// 4. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ü–û–°–õ–ï stage.middleware()
registerGlobalReplyHandlers(bot);
registerMenuHandlers(bot, stage);
```

### üö® –û–ü–ê–°–ù–û: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç FSM!
```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω—ã:
bot.use(session());
bot.use(stage.middleware());
bot.use(globalMiddleware); // ‚Üê middleware –ü–û–°–õ–ï stage –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω—ã!
```

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ2: –ù–ï –¥—É–±–ª–∏—Ä—É–π –∫–æ–º–∞–Ω–¥—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏!
```javascript
// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥:
// –í commands/start.js:
bot.start(handleStart);
bot.command('start', handleStart);
// –í bot.js middleware:
if (text.startsWith('/start')) { handleStart(); } // ‚Üê –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∫–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ:
// –í commands/start.js:
export function registerStartCommand(bot, handleStart) {
  bot.start(handleStart);
  bot.command('start', handleStart); // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
}

// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ bot.hears:
bot.hears("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", ...);  // –≤ bot.js
bot.hears("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", ...);  // –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ - –ë–õ–û–ö–ò–†–£–ï–¢ FSM!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
// –í globalReplyHandlers.js:
bot.hears(["üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"], async (ctx) => {
  if (ctx.scene && ctx.scene.current) {
    await ctx.scene.leave();
  }
  await sendMainMenu(ctx);
});
```

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ3: –°–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è Telegraf 4.x
```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è —Å—Ü–µ–Ω:
scene.on("message:text", async (ctx) => {
  // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Å—Ü–µ–Ω–µ
});

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö:
bot.on("text", async (ctx) => {
  // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
});
```

## üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:
1. **Middleware –ü–û–°–õ–ï stage.middleware()** - –ö–†–ò–¢–ò–ß–ù–û! –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ —Å—Ü–µ–Ω—ã
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (/start, /help)** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ  
3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ bot.hears** - –±–ª–æ–∫–∏—Ä—É–µ—Ç FSM —Å—Ü–µ–Ω—ã
4. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –±–µ–∑ await next()** - –æ–±—Ä—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É
5. **–°–º–µ—à–∏–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä** - –æ—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–¥–µ–ª—å–Ω–æ
6. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π try-catch
7. **–•–∞—Ä–¥–∫–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üìã –ß–µ–∫-–ª–∏—Å—Ç:
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Telegram API  
- [ ] **session() middleware –ü–ï–†–í–´–ô**
- [ ] **–ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –î–û stage.middleware()**
- [ ] **stage.middleware() –ü–û–°–õ–ï –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ middleware**
- [ ] **–ù–ï–¢ middleware –ü–û–°–õ–ï stage.middleware()**
- [ ] –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (/start, /help)
- [ ] –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö bot.hears –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- [ ] –í—Å–µ middleware –≤—ã–∑—ã–≤–∞—é—Ç await next()
- [ ] –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- [ ] –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] SQL –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã
- [ ] –¢–æ–∫–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

**–ü–æ–º–Ω–∏: FSM —Å—Ü–µ–Ω—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏!**
- –í —á–µ–∫-–ª–∏—Å—Ç–µ –∫ PR –¥–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç: [ ] –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ç–æ—á–∫–µ –≤—Ö–æ–¥–∞ (bot.js).
- –ù–µ –¥–æ–ø—É—Å–∫–∞–π—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ /start –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É –∏ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–º—É –±–æ—Ç—É!
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ /start –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π FSM, middleware –∏ —Å—Ü–µ–Ω.# ü§ñ –ü—Ä–∞–≤–∏–ª–∞ Cursor AI - Telegram Bot Development

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û
**Telegram –±–æ—Ç—ã - —ç—Ç–æ –ù–ï –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!** –ù–µ –ø—Ä–∏–º–µ–Ω—è–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–µ–±-–ø—Ä–∞–∫—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## ‚úÖ Telegram —Å–∞–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- CSRF –∑–∞—â–∏—Ç—É
- XSS –∑–∞—â–∏—Ç—É
- Rate limiting
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

## üö´ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è Telegram –±–æ—Ç–æ–≤:
- `SESSION_SECRET` - –Ω–µ –Ω—É–∂–µ–Ω
- `JWT —Ç–æ–∫–µ–Ω—ã` - Telegram ID —É–∂–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `CSRF —Ç–æ–∫–µ–Ω—ã` - –Ω–µ—Ç –≤–µ–±-—Ñ–æ—Ä–º
- `–ü–∞—Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π` - Telegram —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- `–í–µ–±-—Å–µ—Å—Å–∏–∏` - Telegram —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—è–º–∏

## üîß –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

### 1. Webhook
```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
await bot.setWebhook(`${process.env.WEBHOOK_URL}/webhook`);

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
bot.setWebhookInfo(); // –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢
```

### 2. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
```javascript
// ‚ùå –ù–ï —Å–º–µ—à–∏–≤–∞–π inline –∏ reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
// ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
await bot.sendMessage(chatId, '–î–µ–π—Å—Ç–≤–∏—è:', { reply_markup: inlineKeyboard });
await bot.sendMessage(chatId, '–ú–µ–Ω—é:', { reply_markup: replyKeyboard });
```

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const isAdmin = msg.from.id.toString() === process.env.ADMIN_USER_ID;

// –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
await db.query('SELECT * FROM users WHERE telegram_id = $1', [msg.from.id]);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
try {
    await processRequest(msg);
} catch (error) {
    logger.error('–û—à–∏–±–∫–∞:', error);
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
}
```

### 4. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
TELEGRAM_BOT_TOKEN=your_token
ADMIN_USER_ID=your_telegram_id
DATABASE_URL=postgresql://...
WEBHOOK_URL=https://your-domain.com
```

## üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ middleware –∏ FSM

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ1: –ü–æ—Ä—è–¥–æ–∫ middleware –∏–º–µ–µ—Ç —Ä–µ—à–∞—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ—Ä—è–¥–æ–∫ –≤ bot.js:
const bot = new Telegraf(BOT_TOKEN);
const stage = new Scenes.Stage([...scenes]);

// 1. Session middleware –ü–ï–†–í–´–ú
bot.use(session({ defaultSession: () => ({}) }));

// 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –î–û stage.middleware()
bot.use(async (ctx, next) => {
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∏, –ù–û –ù–ï –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥!
  if (ctx.scene && ctx.scene.current) {
    return await next(); // –ü–µ—Ä–µ–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞–º
  }
  // –¢–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞, –ù–ï –∫–æ–º–∞–Ω–¥—ã
  await next();
});

// 3. Stage middleware –¥–ª—è FSM —Å—Ü–µ–Ω
bot.use(stage.middleware());

// 4. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ü–û–°–õ–ï stage.middleware()
registerGlobalReplyHandlers(bot);
registerMenuHandlers(bot, stage);
```

### üö® –û–ü–ê–°–ù–û: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç FSM!
```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω—ã:
bot.use(session());
bot.use(stage.middleware());
bot.use(globalMiddleware); // ‚Üê middleware –ü–û–°–õ–ï stage –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω—ã!
```

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ2: –ù–ï –¥—É–±–ª–∏—Ä—É–π –∫–æ–º–∞–Ω–¥—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏!
```javascript
// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥:
// –í commands/start.js:
bot.start(handleStart);
bot.command('start', handleStart);
// –í bot.js middleware:
if (text.startsWith('/start')) { handleStart(); } // ‚Üê –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∫–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ:
// –í commands/start.js:
export function registerStartCommand(bot, handleStart) {
  bot.start(handleStart);
  bot.command('start', handleStart); // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
}

// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ bot.hears:
bot.hears("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", ...);  // –≤ bot.js
bot.hears("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", ...);  // –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ - –ë–õ–û–ö–ò–†–£–ï–¢ FSM!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
// –í globalReplyHandlers.js:
bot.hears(["üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"], async (ctx) => {
  if (ctx.scene && ctx.scene.current) {
    await ctx.scene.leave();
  }
  await sendMainMenu(ctx);
});
```

### ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ ‚Ññ3: –°–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è Telegraf 4.x
```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è —Å—Ü–µ–Ω:
scene.on("message:text", async (ctx) => {
  // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Å—Ü–µ–Ω–µ
});

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö:
bot.on("text", async (ctx) => {
  // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
});
```

## üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:
1. **Middleware –ü–û–°–õ–ï stage.middleware()** - –ö–†–ò–¢–ò–ß–ù–û! –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ —Å—Ü–µ–Ω—ã
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (/start, /help)** - –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ  
3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ bot.hears** - –±–ª–æ–∫–∏—Ä—É–µ—Ç FSM —Å—Ü–µ–Ω—ã
4. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –±–µ–∑ await next()** - –æ–±—Ä—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É
5. **–°–º–µ—à–∏–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä** - –æ—Ç–ø—Ä–∞–≤–ª—è–π –æ—Ç–¥–µ–ª—å–Ω–æ
6. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π try-catch
7. **–•–∞—Ä–¥–∫–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üìã –ß–µ–∫-–ª–∏—Å—Ç:
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Telegram API  
- [ ] **session() middleware –ü–ï–†–í–´–ô**
- [ ] **–ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware –î–û stage.middleware()**
- [ ] **stage.middleware() –ü–û–°–õ–ï –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ middleware**
- [ ] **–ù–ï–¢ middleware –ü–û–°–õ–ï stage.middleware()**
- [ ] –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (/start, /help)
- [ ] –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö bot.hears –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- [ ] –í—Å–µ middleware –≤—ã–∑—ã–≤–∞—é—Ç await next()
- [ ] –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- [ ] –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] SQL –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã
- [ ] –¢–æ–∫–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

**–ü–æ–º–Ω–∏: FSM —Å—Ü–µ–Ω—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏!**
- –í —á–µ–∫-–ª–∏—Å—Ç–µ –∫ PR –¥–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç: [ ] –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ç–æ—á–∫–µ –≤—Ö–æ–¥–∞ (bot.js).
- –ù–µ –¥–æ–ø—É—Å–∫–∞–π—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ /start –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É –∏ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–º—É –±–æ—Ç—É!
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ /start –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π FSM, middleware –∏ —Å—Ü–µ–Ω.