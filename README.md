# Telegram Bot для теста архетипов

Telegram-бот на Node.js с использованием Telegraf.js для проведения теста из 84 изображений, определяющего 4 наиболее выраженных архетипа личности.

## Функциональность

- ✅ Тест из 84 изображений
- ✅ 12 архетипов (по 7 изображений на каждый)
- ✅ Шкала ответов 0-3 балла
- ✅ Inline-кнопки для ответов
- ✅ Подсчет баллов по архетипам
- ✅ Вывод топ-4 архетипов с процентами
- ✅ Хранение состояния в памяти
- ✅ Готовность к деплою на Render
- ✅ Health check endpoints
- ✅ Webhook поддержка

## Установка и настройка

### 1. Клонирование и установка зависимостей

```bash
npm install
```

### 2. Настройка переменных окружения

Создайте файл `.env` на основе `env.example`:

```bash
cp env.example .env
```

Добавьте в `.env` ваш токен бота и webhook URL:

```
BOT_TOKEN=your_telegram_bot_token_here
WEBHOOK_URL=https://your-app.onrender.com/webhook
```

### 3. Создание бота в Telegram

1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в `.env` файл

### 4. Подготовка изображений и вопросов

#### Структура папки `questions/`:
```
questions/
├── изображение1.jpg
├── изображение2.png
├── изображение3.gif
└── ...
```

#### Структура файла `questions.json`:
```json
{
  "Название архетипа 1": [
    "изображение1",
    "изображение2",
    "изображение3",
    "изображение4",
    "изображение5",
    "изображение6",
    "изображение7"
  ],
  "Название архетипа 2": [
    "изображение8",
    "изображение9",
    "изображение10",
    "изображение11",
    "изображение12",
    "изображение13",
    "изображение14"
  ]
}
```

**Важно:**
- Названия в массивах должны точно соответствовать именам файлов изображений (без расширения)
- Поддерживаемые форматы: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`
- Каждый архетип должен содержать ровно 7 изображений
- Всего 84 изображения (12 × 7)

### 5. Запуск бота

**Локально:**
```bash
npm start
```

**Для разработки (с автоперезагрузкой):**
```bash
npm run dev
```

## Деплой на Render

1. Создайте аккаунт на [Render.com](https://render.com)
2. Создайте новый Web Service
3. Подключите ваш GitHub репозиторий
4. Настройте переменные окружения:
   - `BOT_TOKEN`: ваш токен бота
   - `WEBHOOK_URL`: `https://your-app-name.onrender.com/webhook`
5. Установите команду запуска: `npm start`
6. Настройте Health Check Path: `/health`
7. Деплойте!

### Webhook Endpoints

После деплоя бот предоставляет следующие endpoints:

- **`/webhook`** - Основной webhook endpoint для Telegram (POST)
- **`/set-webhook`** - Автоматическая установка webhook (GET)
- **`/health`** - Подробная информация о состоянии бота
- **`/status`** - Краткая информация о статусе
- **`/`** - Основной health check (аналогично `/health`)

### Установка Webhook

После деплоя на Render:

1. **Автоматически** - если установлена переменная `WEBHOOK_URL`
2. **Вручную** - перейдите по ссылке: `https://your-app.onrender.com/set-webhook`
3. **Через API** - отправьте POST запрос на `/set-webhook`

**Пример ответа `/set-webhook`:**
```json
{
  "success": true,
  "webhookUrl": "https://your-app.onrender.com/webhook",
  "message": "Webhook установлен успешно"
}
```

### Health Check Endpoints

**Пример ответа `/health`:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "bot": {
    "name": "Archetype Test Bot",
    "version": "1.0.0",
    "uptime": 3600,
    "users": 5,
    "questions": 84,
    "archetypes": 12,
    "webhook": true
  },
  "system": {
    "memory": {...},
    "platform": "linux",
    "nodeVersion": "v18.0.0"
  }
}
```

## Использование

1. Найдите вашего бота в Telegram
2. Отправьте команду `/start`
3. Отвечайте на изображения, выбирая 0, 1, 2 или 3
4. Получите результаты с топ-4 архетипами

## Структура проекта

```
├── index.js          # Основная логика бота
├── questions.json    # Названия изображений (архетипы -> названия[])
├── questions/        # Папка с изображениями
├── package.json      # Зависимости и скрипты
├── env.example       # Пример переменных окружения
└── README.md         # Документация
```

## Технические детали

- **Фреймворк:** Telegraf.js
- **Хранение данных:** Map в оперативной памяти
- **Деплой:** Готов к Render с webhook
- **Обработка ошибок:** Graceful shutdown
- **Модульность:** Чистый, понятный код
- **Изображения:** Поддержка JPG, PNG, GIF, WebP
- **Fallback:** Текстовые сообщения при отсутствии изображений
- **Health Check:** HTTP endpoints для мониторинга
- **Webhook:** Полная поддержка webhook для production

## Поддержка

При возникновении проблем:
1. Проверьте правильность токена бота
2. Убедитесь, что `questions.json` содержит валидный JSON
3. Проверьте, что названия в JSON соответствуют файлам в папке `questions/`
4. Убедитесь, что все 12 архетипов имеют по 7 изображений
5. Проверьте логи в консоли
6. Проверьте health check endpoints
7. Убедитесь, что webhook установлен корректно
