const fs = require('fs');
const path = require('path');

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤
const archetypesData = JSON.parse(fs.readFileSync('./questions.json', 'utf8'));

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ (—Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ)
function calculateScores(answers) {
  const scores = new Map();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
  Object.keys(archetypesData).forEach(archetype => {
    scores.set(archetype, 0);
  });
  
  // –ü–æ–¥—Å—á–µ—Ç –±–∞–ª–ª–æ–≤
  answers.forEach(answer => {
    const scoreForAnswer = 3 - answer.answer; // 0->3, 1->2, 2->1, 3->0
    const currentScore = scores.get(answer.archetype) || 0;
    scores.set(answer.archetype, currentScore + scoreForAnswer);
  });
  
  return scores;
}

// –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
function runTests() {
  console.log('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–æ–¥—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤...\n');
  
  // –¢–µ—Å—Ç 1: –í—Å–µ –æ—Ç–≤–µ—Ç—ã "–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–µ–Ω" (0)
  console.log('–¢–µ—Å—Ç 1: –í—Å–µ –æ—Ç–≤–µ—Ç—ã "–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–µ–Ω"');
  const testAnswers1 = [
    { archetype: '–ü—Ä–∞–≤–∏—Ç–µ–ª—å', answer: 0 },
    { archetype: '–ü—Ä–∞–≤–∏—Ç–µ–ª—å', answer: 0 },
    { archetype: '–ü—Ä–∞–≤–∏—Ç–µ–ª—å', answer: 0 }
  ];
  const scores1 = calculateScores(testAnswers1);
  console.log('–ü—Ä–∞–≤–∏—Ç–µ–ª—å:', scores1.get('–ü—Ä–∞–≤–∏—Ç–µ–ª—å'), '–±–∞–ª–ª–æ–≤ (–æ–∂–∏–¥–∞–µ—Ç—Å—è 9)');
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', scores1.get('–ü—Ä–∞–≤–∏—Ç–µ–ª—å') === 9 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù');
  console.log('');
  
  // –¢–µ—Å—Ç 2: –í—Å–µ –æ—Ç–≤–µ—Ç—ã "–≠—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è" (3)
  console.log('–¢–µ—Å—Ç 2: –í—Å–µ –æ—Ç–≤–µ—Ç—ã "–≠—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è"');
  const testAnswers2 = [
    { archetype: '–®—É—Ç', answer: 3 },
    { archetype: '–®—É—Ç', answer: 3 },
    { archetype: '–®—É—Ç', answer: 3 }
  ];
  const scores2 = calculateScores(testAnswers2);
  console.log('–®—É—Ç:', scores2.get('–®—É—Ç'), '–±–∞–ª–ª–æ–≤ (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0)');
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', scores2.get('–®—É—Ç') === 0 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù');
  console.log('');
  
  // –¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
  console.log('–¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã');
  const testAnswers3 = [
    { archetype: '–í–æ–∏–Ω', answer: 0 }, // 3 –±–∞–ª–ª–∞
    { archetype: '–í–æ–∏–Ω', answer: 1 }, // 2 –±–∞–ª–ª–∞
    { archetype: '–í–æ–∏–Ω', answer: 2 }, // 1 –±–∞–ª–ª
    { archetype: '–í–æ–∏–Ω', answer: 3 }  // 0 –±–∞–ª–ª–æ–≤
  ];
  const scores3 = calculateScores(testAnswers3);
  console.log('–í–æ–∏–Ω:', scores3.get('–í–æ–∏–Ω'), '–±–∞–ª–ª–æ–≤ (–æ–∂–∏–¥–∞–µ—Ç—Å—è 6)');
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', scores3.get('–í–æ–∏–Ω') === 6 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù');
  console.log('');
  
  // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –±–∞–ª–ª–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ä—Ö–µ—Ç–∏–ø–∞
  console.log('–¢–µ—Å—Ç 4: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–ª–ª—ã –¥–ª—è –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤');
  Object.keys(archetypesData).forEach(archetype => {
    const questionCount = archetypesData[archetype].length;
    const maxPossibleScore = questionCount * 3;
    console.log(`${archetype}: ${questionCount} –≤–æ–ø—Ä–æ—Å–æ–≤, –º–∞–∫—Å–∏–º—É–º ${maxPossibleScore} –±–∞–ª–ª–æ–≤`);
  });
  console.log('');
  
  // –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–æ–º–µ—Ä–∞–º
  console.log('–¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–æ–º–µ—Ä–∞–º');
  const questionsFolder = path.join(__dirname, 'questions');
  const imageFiles = fs.readdirSync(questionsFolder)
    .filter(file => file.match(/^\d+\.jpg$/))
    .map(file => parseInt(file.replace('.jpg', '')))
    .sort((a, b) => a - b);
  
  console.log('–ù–∞–π–¥–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–æ–º–µ—Ä–∞–º–∏:', imageFiles);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–æ–º–µ—Ä–∞ –∏–∑ questions.json —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
  const allQuestionNumbers = new Set();
  Object.values(archetypesData).forEach(numbers => {
    numbers.forEach(num => allQuestionNumbers.add(parseInt(num)));
  });
  
  const missingImages = Array.from(allQuestionNumbers).filter(num => !imageFiles.includes(num));
  const extraImages = imageFiles.filter(num => !allQuestionNumbers.has(num));
  
  if (missingImages.length === 0 && extraImages.length === 0) {
    console.log('‚úÖ –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –Ω–æ–º–µ—Ä–∞–º –≤ questions.json');
  } else {
    if (missingImages.length > 0) {
      console.log('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤:', missingImages);
    }
    if (extraImages.length > 0) {
      console.log('‚ö†Ô∏è –õ–∏—à–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–æ–º–µ—Ä–∞–º–∏:', extraImages);
    }
  }
  
  // –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è PDF —Ñ–∞–π–ª–æ–≤ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤
  console.log('\n–¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è PDF —Ñ–∞–π–ª–æ–≤ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤');
  const answersFolder = path.join(__dirname, 'answers');
  if (fs.existsSync(answersFolder)) {
    const pdfFiles = fs.readdirSync(answersFolder).filter(file => file.endsWith('.pdf'));
    console.log('–ù–∞–π–¥–µ–Ω—ã PDF —Ñ–∞–π–ª—ã:', pdfFiles);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PDF —Ñ–∞–π–ª–æ–≤ –∞—Ä—Ö–µ—Ç–∏–ø–∞–º
    const archetypeNames = Object.keys(archetypesData);
    const missingPdfs = archetypeNames.filter(archetype => {
      const pdfPath = path.join(answersFolder, archetype.toLowerCase() + '.pdf');
      return !fs.existsSync(pdfPath);
    });
    
    if (missingPdfs.length === 0) {
      console.log('‚úÖ –í—Å–µ PDF —Ñ–∞–π–ª—ã –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ –Ω–∞–π–¥–µ–Ω—ã');
    } else {
      console.log('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç PDF —Ñ–∞–π–ª—ã –¥–ª—è –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤:', missingPdfs);
    }
  } else {
    console.log('‚ùå –ü–∞–ø–∫–∞ answers/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }
  
  // –¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Ç–æ–ø-4 –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏—Ö —Å—É–º–º—ã
  console.log('\n–¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Ç–æ–ø-4 –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏—Ö —Å—É–º–º—ã');
  // –ü—Ä–∏–º–µ—Ä: 4 –∞—Ä—Ö–µ—Ç–∏–ø–∞ —Å –±–∞–ª–ª–∞–º–∏ 10, 20, 30, 40
  const top4 = [
    ['–ê—Ä—Ö–µ—Ç–∏–ø1', 10],
    ['–ê—Ä—Ö–µ—Ç–∏–ø2', 20],
    ['–ê—Ä—Ö–µ—Ç–∏–ø3', 30],
    ['–ê—Ä—Ö–µ—Ç–∏–ø4', 40],
  ];
  const topSum = top4.reduce((acc, [_, score]) => acc + score, 0);
  const percents = top4.map(([name, score]) => Math.round((score / topSum) * 100));
  console.log('–ë–∞–ª–ª—ã:', top4.map(([_, score]) => score));
  console.log('–°—É–º–º–∞:', topSum);
  console.log('–ü—Ä–æ—Ü–µ–Ω—Ç—ã:', percents);
  const expected = [10, 20, 30, 40].map(v => Math.round((v/100)*100)); // [10, 20, 30, 40]
  const ok = percents.join(',') === expected.join(',');
  console.log('–û–∂–∏–¥–∞–µ—Ç—Å—è:', expected);
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', ok ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù');
  
  // –¢–µ—Å—Ç 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è media group –∏–∑ 4 PDF-—Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–æ–ø-4 –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤
  console.log('\n–¢–µ—Å—Ç 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è media group –∏–∑ 4 PDF-—Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–æ–ø-4 –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤');
  // –ú–æ–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é getArchetypePdfPath
  function mockGetArchetypePdfPath(name) {
    return `/mock/path/${name.toLowerCase()}.pdf`;
  }
  const top4Archetypes = [
    ['–ü—Ä–∞–≤–∏—Ç–µ–ª—å', 15],
    ['–®—É—Ç', 12],
    ['–í–æ–∏–Ω', 10],
    ['–ú—É–¥—Ä–µ—Ü', 8]
  ];
  const expectedDocs = [
    { type: 'document', media: { source: '/mock/path/–ø—Ä–∞–≤–∏—Ç–µ–ª—å.pdf' } },
    { type: 'document', media: { source: '/mock/path/—à—É—Ç.pdf' } },
    { type: 'document', media: { source: '/mock/path/–≤–æ–∏–Ω.pdf' } },
    { type: 'document', media: { source: '/mock/path/–º—É–¥—Ä–µ—Ü.pdf' } }
  ];
  const docs = [];
  for (let i = 0; i < top4Archetypes.length; i++) {
    const [archetypeName] = top4Archetypes[i];
    const pdfPath = mockGetArchetypePdfPath(archetypeName);
    if (pdfPath) {
      docs.push({ type: 'document', media: { source: pdfPath } });
    }
  }
  const ok8 = JSON.stringify(docs) === JSON.stringify(expectedDocs);
  console.log('–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:', docs);
  console.log('–û–∂–∏–¥–∞–µ—Ç—Å—è:', expectedDocs);
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', ok8 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù');
  
  console.log('\nüéØ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!');
}

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
runTests(); 